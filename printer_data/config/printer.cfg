[respond]
[include chopper_tune.cfg]
######################################################################
#####  Voron Design VoronZ 2.4 400mm Spider TMC2209 UART config  #####
######################################################################

# In loving memory of the original Anycubic Chiron that got taken
# apart to give birth to such a wonderful machine: The VoronZ



######################################################################
#   General
######################################################################


# Fysetc Spider as main MCU
[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" 
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_340014000B50315239323320-if00


# CANBUS board as secondary MCU
[mcu EBBCan]
##  Obtain definition by "ls -l /dev/serial/by-id/" 
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1A00360011504B5735313720-if00

[mcu eddy]
##  Obtain definition by "ls -l /dev/serial/by-id/" 
serial: /dev/serial/by-id/usb-Klipper_rp2040_50445061304FDA1C-if00
restart_method: command

[probe_eddy_ng btt_eddy]
sensor_type: btt_eddy
i2c_mcu: eddy
i2c_bus: i2c0f
x_offset: 0
y_offset: 26

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu
sensor_mcu: eddy
min_temp: 10
max_temp: 100

[temperature_sensor btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26

[safe_z_home]
home_xy_position: 200, 200
z_hop: 10
z_hop_speed: 25
speed: 900



[gcode_macro G28]
rename_existing: G28.1
gcode:
  SET_SERVO SERVO=servo ANGLE=185
  G28.1 {rawparams}
  {% if not rawparams or (rawparams and 'Z' in rawparams) %}
    PROBE
  {% endif %}




# CANBUS input shaper accelerometer
[adxl345]
cs_pin: EBBCan: PB12
spi_software_sclk_pin: EBBCan: PB10
spi_software_mosi_pin: EBBCan: PB11
spi_software_miso_pin: EBBCan: PB2
axes_map: x,y,z

# Accelerometer position
[resonance_tester]  
accel_chip: adxl345  
probe_points:  
    200, 200, 100
hz_per_sec: 1

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
number_of_results_to_keep: 10
keep_raw_data: False
show_macros_in_webui: True
timeout: 600 # Max processing time
measurements_chunk_size: 10
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
max_freq: 100
dpi: 300 # Risoluzione grafici


# Printer details
[printer]
kinematics: corexy
max_velocity: 900				#default =  300 mm/s
max_accel: 3500			    	#default = 3000 mm/ss, i profili fast di Orca la impostano a 4500
max_z_velocity: 100				#default =   20 mm/s
max_z_accel: 2000				#default =  500 mm/s
square_corner_velocity: 30.0	#default =  5.0 mm/s, i profili fast di Orca la impostano a 50


# Virtual SD Card used to load gcodes in Fluidd / Mainsail
[virtual_sdcard]
path: /home/pi/printer_data/gcodes

# Needed bu Fluidd
[display_status]


# Needed by Fluidd
[pause_resume]



#####################################################################
#   Thermistors
#####################################################################


# TB - SSR temperature
[temperature_sensor relays]
sensor_type: Generic 3950
sensor_pin: PB0
max_temp: 80

# T3 - Power spply temperature
[temperature_sensor psu]
sensor_type: Generic 3950
sensor_pin: PC3
max_temp: 80


# T4 - Chamber temperature
[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PB1
max_temp: 60


# MKS Pi Board v1.1 - CPU temperature
[temperature_sensor raspberry_Pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100


# Fysetc SPider v3.0 - MCU temperature un
[temperature_sensor fysetc_spider]
sensor_type: temperature_mcu
sensor_mcu: mcu
sensor_temperature1: 80
sensor_adc1:0.26

# Thermistors for beds and extruder are declared in their sections
max_temp: 130

# EBB36 - CANBUS Board temperature
[temperature_sensor EBB36]
sensor_type: temperature_mcu
sensor_mcu: EBBCan
max_temp: 100



#####################################################################
#   Heaters
#####################################################################

# HEAT0 - Large bed
[heater_generic large_bed]
heater_pin: PB15				#HEAT0
sensor_type: Generic 3950
sensor_pin: PC1					#T1
max_power: 0.9
min_temp: 0
max_temp: 130
control: pid
pid_kp: 58.015
pid_ki: 1.357
pid_kd: 620.040
pwm_cycle_time: 0.02674 # 37.4Hz

# Large bed thermal runout
[verify_heater large_bed]
max_error: 130
#   The maximum "cumulative temperature error" before raising an
#   error. Smaller values result in stricter checking and larger
#   values allow for more time before an error is reported.
#   Specifically, the temperature is inspected once a second and if it
#   is close to the target temperature then an internal "error
#   counter" is reset; otherwise, if the temperature is below the
#   target range then the counter is increased by the amount the
#   reported temperature differs from that range. Should the counter
#   exceed this "max_error" then an error is raised. The default is
#   120.
check_gain_time: 60
#   How many seconds between one temperature check and the following.
#	Default is 60s for beds and 30s for extruders
hysteresis: 5
#   The maximum temperature difference (in Celsius) to a target
#   temperature that is considered in range of the target. This
#   controls the max_error range check. The default is 5.
heating_gain: 1
#   The minimum temperature (in Celsius) that the heater must increase
#   by during the check_gain_time check. It is rare to customize this
#   value. The default is 2.


# HEAT1 - Small bed
[heater_generic small_bed]
heater_pin: PC8					#HEAT1
sensor_type: Generic 3950
sensor_pin: PC0					#T0
max_power: 0.25
min_temp: 0
max_temp: 130
control: pid
pid_kp: 33.766
pid_ki: 1.294
pid_kd: 220.325
pwm_cycle_time: 0.02674 # 37.4Hz

# Small bed thermal runout
[verify_heater small_bed]
max_error: 130
#   The maximum "cumulative temperature error" before raising an
#   error. Smaller values result in stricter checking and larger
#   values allow for more time before an error is reported.
#   Specifically, the temperature is inspected once a second and if it
#   is close to the target temperature then an internal "error
#   counter" is reset; otherwise, if the temperature is below the
#   target range then the counter is increased by the amount the
#   reported temperature differs from that range. Should the counter
#   exceed this "max_error" then an error is raised. The default is
#   120.
check_gain_time: 60
#   How many seconds between one temperature check and the following.
#	Default is 60s for beds and 30s for extruders
hysteresis: 5
#   The maximum temperature difference (in Celsius) to a target
#   temperature that is considered in range of the target. This
#   controls the max_error range check. The default is 5.
heating_gain: 1
#   The minimum temperature (in Celsius) that the heater must increase
#   by during the check_gain_time check. It is rare to customize this
#   value. The default is 2.





#####################################################################
#   Fan Control
#####################################################################


# FAN1 - Hotend fan
[heater_fan hotend_fan]
#pin: PA13
pin: EBBCan: PA1
max_power: 1.0
heater: extruder
heater_temp: 50.0

# FAN1 - Strong exhaust fan
[fan_generic strong_exhaust_fan]
pin: PA14
max_power: 1.0
shutdown_speed: 0
kick_start_time: 0.2
off_below: 0.15

# FAN2 - Part cooling fan
[fan]
pin: EBBCan: PA0
max_power: 1.0
shutdown_speed: 1.0
kick_start_time: 0.2
off_below: 0.15

# FAN2 - Electronics bay fan
[controller_fan electronics_fan]
pin: PB2
max_power: 0.5
hardware_pwm: True
shutdown_speed: 0
kick_start_time: 0.2
off_below: 0.15
heater: extruder, small_bed, large_bed
stepper: stepper_x, stepper_y, stepper_z, stepper_z1, stepper_z2, stepper_z3, extruder

# FAN4 - Nevermore filter fan
[fan_generic nevermore_fan]
pin: PB7
max_power: 1.0
shutdown_speed: 1.0
kick_start_time: 0.2
off_below: 0.15

# FAN5 - PSU fan
[controller_fan psu_fan]
pin: PB5
max_power: 0.8
hardware_pwm: True
shutdown_speed: 1.0
kick_start_time: 0.2
off_below: 0.15
heater: extruder, small_bed, large_bed




#####################################################################
#   LED Control
#####################################################################


# BED OUT - Chamber LEDs
[output_pin caselight]
pin: PB4
pwm: false
value: 1.0
shutdown_value: 0


# Chamber LEDs ON button
[gcode_button led_button_on]
pin: ^PA2
press_gcode:
    Caselight_ON

# Chamber LEDs OFF button
[gcode_button led_button_off]
pin: ^!PA0
press_gcode:
    Caselight_OFF




#####################################################################
#   Laser
#####################################################################

[pwm_tool laser]
pin: PA13
value: 0
shutdown_value: 0
cycle_time: 0.001


#####################################################################
#   Endstops
#####################################################################

# Z-max - Clicky probe
#[probe]
#pin: ^PA3
#pin: ^EBBCan: PB9
#x_offset: 0
#y_offset: 19.75
#z_offset: 3.0 #Decrease for longer nozzle, increase for shorter nozzle
#speed: 15
#lift_speed: 50
#samples: 3
#samples_result: average
#sample_retract_dist: 1.0
#samples_tolerance: 0.1
#samples_tolerance_retries: 3





#####################################################################
#   X/Y Stepper Settings
#####################################################################

#TMC Autotune
#[autotune_tmc stepper_x]
#motor: a_b_motor
#tuning_goal: performance
#sg4_thrs: 170

#[autotune_tmc stepper_y]
#motor: a_b_motor
#tuning_goal: performance
#sg4_thrs: 197


# X-MOT (B Motor)
[stepper_x]
step_pin: PE11
dir_pin: !PE10
enable_pin: !PE9
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: 0

position_endstop: 405
position_max: 405
homing_speed: 100   #Max 100
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PE7
interpolate: False
run_current: 1.15
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PB14
driver_SGTHRS: 170 #Homing sensitivity: 255 is most sensitive value, 0 is least sensitive

driver_TBL: 0
driver_TOFF: 1
driver_HSTRT: 0
driver_HEND: 2


# Y-MOT (A Motor)
[stepper_y]
step_pin: PD8
dir_pin: !PB12
enable_pin: !PD9
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: 0

position_endstop: 410
position_max: 410
homing_speed: 100  #Max 100
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: PE15
interpolate: False
run_current: 1.15
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PB13
driver_SGTHRS: 190 #Homing sensitivity: 255 is most sensitive value, 0 is least sensitive

driver_TBL: 0
driver_TOFF: 1
driver_HSTRT: 0
driver_HEND: 2



#####################################################################
#   Z Steppers Settings
#####################################################################


# M2 Stepper - Front Left
[stepper_z]
step_pin: PD14
dir_pin: !PD13
enable_pin: !PD15
rotation_distance: 39.92    #default = 40
gear_ratio: 80:16
microsteps: 32
endstop_pin: probe:z_virtual_endstop

position_max: 330
position_min: -3
homing_speed: 10
second_homing_speed: 5
homing_retract_dist: 3

[tmc2209 stepper_z]
uart_pin: PD10
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0


# M4 Stepper - Rear Left
[stepper_z1]
step_pin: PD5
dir_pin: PD6
enable_pin: !PD4
rotation_distance:  39.92
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z1]
uart_pin: PD7
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0


# M5 Stepper - Rear Right
[stepper_z2]
step_pin: PE2
dir_pin: !PE4
enable_pin: !PE3
rotation_distance:  39.92
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PC15
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0


# M6 Stepper - Front Right
[stepper_z3]
step_pin: PD12
dir_pin: PC4
enable_pin: !PE8
rotation_distance:  39.92
gear_ratio: 80:16
microsteps: 32

[tmc2209 stepper_z3]
uart_pin: PA15
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0





#####################################################################
#   Extruder
#####################################################################


[extruder]
step_pin: EBBCan: PD0
dir_pin: EBBCan: PD1
enable_pin: !EBBCan: PD2
rotation_distance: 47.088
gear_ratio: 9:1
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.600
filament_diameter: 1.75
max_extrude_cross_section: 50
max_extrude_only_distance: 500
heater_pin: EBBCan: PB13
sensor_type: Generic 3950
sensor_pin: EBBCan: PA3
min_temp: 0
max_temp: 320
max_power: 1
min_extrude_temp: 170
pressure_advance: 0.03		#tested by me

[tmc2209 extruder]
uart_pin: EBBCan: PA15
interpolate: false
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0


# Extruder thermal runout
[verify_heater extruder]
max_error: 250
#   The maximum "cumulative temperature error" before raising an
#   error. Smaller values result in stricter checking and larger
#   values allow for more time before an error is reported.
#   Specifically, the temperature is inspected once a second and if it
#   is close to the target temperature then an internal "error
#   counter" is reset; otherwise, if the temperature is below the
#   target range then the counter is increased by the amount the
#   reported temperature differs from that range. Should the counter
#   exceed this "max_error" then an error is raised. The default is
#   120.
check_gain_time: 60
#   How many seconds between one temperature check and the following.
#	Default is 60s for beds and 30s for extruders
hysteresis: 10
#   The maximum temperature difference (in Celsius) to a target
#   temperature that is considered in range of the target. This
#   controls the max_error range check. The default is 5.
heating_gain: 1
#   The minimum temperature (in Celsius) that the heater must increase
#   by during the check_gain_time check. It is rare to customize this
#   value. The default is 2.





#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################


# Bed mesh measurement
[bed_mesh]
speed: 900 
mesh_min: 10, 30
mesh_max: 395, 380
probe_count: 9, 9
algorithm: bicubic
horizontal_move_z: 2


# Printer on idle timeout
[idle_timeout]
timeout: 300
gcode:
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0


# Quad gantry level
[quad_gantry_level]
gantry_corners: #I set the posizion of the inner corners of the extrusions
   -63,-22
   461,501

points:
   50,25
   50,325
   350,325
   350,25
speed: 900
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.15
max_adjust: 10


[servo servo]
pin: PD3
maximum_servo_angle: 190


# Skew correction on XY, XZ and YZ
[skew_correction]


# Exclude failed portions of print
[exclude_object]





##########################################################	
########################  Macros  ########################
##########################################################

[gcode_macro CLEAN_NOZZLE]
gcode:
    G90
    G1 X204 Y401 F12000
    SET_SERVO SERVO=servo ANGLE=100
    G91
    G1 X-42 F12000
    G1 Y-2 F12000
    G1 X42 F12000
    G1 Y2 F12000
    G1 X-42 F12000
    G1 Y-2 F12000
    G1 X42 F12000
    G1 Y2 F12000
    G1 X-42 F12000
    G1 Y-2 F12000
    G1 X42 F12000
    G1 Y2 F12000
    G1 X-42 F12000
    G1 Y-2 F12000
    G1 X42 F12000
    G1 Y2 F12000
    G1 X-42 F12000
    G1 Y-2 F12000
    G1 X42 F12000
    G1 Y2 F12000
    G1 X-42 F12000
    G1 Y-2 F12000
    G1 X42 F12000
    G1 Y2 F12000
    G1 X-42 F12000
    G1 Y-2 F12000
    G1 X42 F12000
    G1 Y2 F12000
    G1 X-42 F12000
    G1 Y-2 F12000
    G1 X42 F12000
    G1 Y2 F12000
    G90
    SET_SERVO SERVO=servo ANGLE=185




[gcode_macro PARK]
gcode:
    M3 S0
    M5
    # Parameters
    {% set z = params.Z|default(10)|int %}                                                   ; z hop amount

    {% if printer['pause_resume'].is_paused|int == 0 %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}                              ; set z hop variable for reference in resume macro
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}    ; set hotend temp variable for reference in resume macro

        SAVE_GCODE_STATE NAME=PAUSE                                                          ; save current print position for resume
        BASE_PAUSE                                                                           ; pause print
        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}       ; check that zhop doesn't exceed z max
            G91                                                                              ; relative positioning
            G1 Z{z} F900                                                                     ; raise Z up by z hop amount
        {% else %}
            { action_respond_info("Pause zhop exceeds maximum Z height.") }                  ; if z max is exceeded, show message and set zhop value for resume to 0
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}
        G90                                                                                  ; absolute positioning
        G1 X{printer.toolhead.axis_maximum.x/2} Y5 F6000                                     ; park toolhead at front center
        SAVE_GCODE_STATE NAME=PAUSEPARK                                                      ; save parked position in case toolhead is moved during the pause (otherwise the return zhop can error)
        SET_IDLE_TIMEOUT TIMEOUT=60                                                          ; set timeout to 1 minute
        M104 S0                                                                              ; turn off hotend
        SET_IDLE_TIMEOUT TIMEOUT=432000                                                      ; set timeout to 120 hours
    {% endif %} 




[gcode_macro PRINT_START]
# Variable for adaptive bed besh
variable_buffer: 20
gcode:
	# This part fetches data from your slicer. Such as bed temp, extruder temp, chamber temp and size of your printer.
	{% set target_bed = params.BED|int %}
	{% set heat = params.HEAT|int %}
	{% set target_extruder = params.EXTRUDER|int %}
    {% set pa = params.PR_ADV|float %}
    {% set print_min_x = params.PRINT_MIN.split(",")[0]|float %}
    {% set print_min_y = params.PRINT_MIN.split(",")[1]|float %}
    {% set print_max_x = params.PRINT_MAX.split(",")[0]|float %}
    {% set print_max_y = params.PRINT_MAX.split(",")[1]|float %}

    # Set pressure advance based on filament from slicer
    SET_PRESSURE_ADVANCE ADVANCE={ pa }

    # Choosing what bed to use: 0 = Large Bed, 1 = Small Bed (actually, I always get HEAT=0, but choose later if to switch to the small bed depending on print size and bed T)
    {% if heat == 0 %}
        {% set what_bed = "large_bed" %}
        # Preheating the bed
        SET_HEATER_TEMPERATURE HEATER={ what_bed } TARGET={ target_bed } # Sets the target temp for the bed
    {% elif heat == 1 %}
        {% set what_bed = "small_bed" %}
        # Preheating the bed
        SET_HEATER_TEMPERATURE HEATER={ what_bed } TARGET={ target_bed + 20 } # Sets the target temp for the bed
    {% endif %}

	# Turn on Nevermore filter fan if the bed temperature is over that of PET-G
	{% if target_bed >= 80 %}
		SET_FAN_SPEED FAN=nevermore_fan SPEED=0.65
	{% else %}
		SET_FAN_SPEED FAN=nevermore_fan SPEED=0
	{% endif %}
    
    SET_SERVO SERVO=servo ANGLE=185

    # Homing
	STATUS_HOMING												# Sets SB-leds to homing-mode
	G28 X y
    G28 Z                      ; do the coarse home
    G90                        ; set absolute positioning
    G0 Z2 F1000                ; to 2mm -- home height (or whatever you'd like), for maximum sensor accuracy
    G4 S1                      ; chill for a sec
    M400                       ; wait for move to finish
    PROBE_EDDY_NG_PROBE_STATIC HOME_Z=1 ; read the current exact height from sensor and home Z to it
    G0 Z5 F1000                ; to 5mm as home
	G90                   										# Absolut position

	# Quad gantry level
	BED_MESH_CLEAR       										# Clears old saved bed mesh (if any)
	STATUS_LEVELING												# Sets SB-leds to leveling-mode
	G90
    QUAD_GANTRY_LEVEL
    G90                        ; set absolute positioning
    G0 X200 Y200 Z10 F54000

    # Waiting to reach bed temperature
    STATUS_HEATING												# Sets SB-leds to heating-mode
 	TEMPERATURE_WAIT SENSOR="heater_generic { what_bed }" MINIMUM={ target_bed - 5 } MAXIMUM={ target_bed + 100 }	# Waits for bed to heat up

    # Tap Z
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150 # Sets the target temp for the extruder
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150 MAXIMUM=155
    CLEAN_NOZZLE
    G90                        ; set absolute positioning
    G0 X200 Y200 Z10 F54000
    PROBE_EDDY_NG_TAP TARGET_Z=-0.5

    # Meshing
	STATUS_MESHING                     							# Sets SB-leds to bed mesh-mode
        # if object inside small area on the right, and Tbed < 65Â°C, turn on small bed and turn off large bed
        {% if (print_min_x > 255) and (print_min_y > 155) and (print_max_y < 255) and (target_bed < 81) %}
            SET_HEATER_TEMPERATURE HEATER=large_bed TARGET=0
            SET_HEATER_TEMPERATURE HEATER=small_bed TARGET={ target_bed + 5}
        {% endif %}
    bed_mesh_calibrate method=rapid_scan

    # Heat-up the extruder
    G1 X200 Y200 Z10 F54000							# Goes to center of the bed
	STATUS_HEATING												# Sets SB-leds to heating-mode

    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={ target_extruder } # Sets the target temp for the extruder
 	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={ target_extruder - 10 } MAXIMUM={ target_extruder + 20 }	# Waits for extruder to heat up

    # Eventually turn on exhaust fan
#	{% if target_bed >= 85 %}
#		SET_FAN_SPEED FAN=exhaust_fan SPEED=0.3
#	{% else %}
#		SET_FAN_SPEED FAN=exhaust_fan SPEED=0.2
#	{% endif %}

    # Start printing
	STATUS_PRINTING												# Sets SB-leds to printing-mode
	G0 X405 Y250 F54000			        						# Moves to starting point
	G0 Z1														# Raises Z to 1
	G91															# Incremental positioning 
	G1 Y-100 E20 F1000											# Purge line
	G90															# Absolut position
    SKEW_PROFILE LOAD=CaliFlower


  

[gcode_macro PRINT_END]
gcode:
    SET_PIN PIN=caselight VALUE=1

    # Safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SET_SKEW CLEAR=1
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400														# Wait for buffer to clear
    G92 E0														# Zero the extruder
    G1 E-5.0 F1800												# Retract filament
    
	G91															# Relative positioning
	G0 Z1														# Lift Z by 1mm
	G90															# ABsolute positioning
	G0 X400 Y405												# Move toolhead away

    TURN_OFF_HEATERS											# Turn off heaters
    M84															# Disable motors
    M107														# Turn off fan


    # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
    # command pair is to restore the printer's coordinate system
    # and speed settings since the commands above change them.
    # However, to prevent any accidental, unintentional toolhead
    # moves when restoring the state, explicitly set MOVE=0.
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0
    G4 P54000                                                   #wait 30s
    Caselight_OFF
    SET_FAN_SPEED FAN=nevermore_fan SPEED=0
#    SET_FAN_SPEED FAN=exhaust_fan SPEED=0
    BED_MESH_CLEAR



[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    # Parameters
    {% set z = params.Z|default(10)|int %}                                                   ; z hop amount

    {% if printer['pause_resume'].is_paused|int == 0 %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}                              ; set z hop variable for reference in resume macro
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}    ; set hotend temp variable for reference in resume macro

        SAVE_GCODE_STATE NAME=PAUSE                                                          ; save current print position for resume
        BASE_PAUSE                                                                           ; pause print
        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}       ; check that zhop doesn't exceed z max
            G91                                                                              ; relative positioning
            G1 Z{z} F900                                                                     ; raise Z up by z hop amount
        {% else %}
            { action_respond_info("Pause zhop exceeds maximum Z height.") }                  ; if z max is exceeded, show message and set zhop value for resume to 0
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}
        G90                                                                                  ; absolute positioning
        G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5} F6000   ; park toolhead at front center
        SAVE_GCODE_STATE NAME=PAUSEPARK                                                      ; save parked position in case toolhead is moved during the pause (otherwise the return zhop can error)
        M104 S0                                                                              ; turn off hotend
        SET_IDLE_TIMEOUT TIMEOUT=43200                                                       ; set timeout to 12 hours
    {% endif %}




[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
gcode:
    # Parameters
    {% set e = params.E|default(2.5)|int %}                                          ; hotend prime amount (in mm)

    {% if printer['pause_resume'].is_paused|int == 1 %}
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}  ; set timeout back to configured value
        {% if etemp > 0 %}
            M109 S{etemp|int}                                                        ; wait for hotend to heat back up
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100                     ; go back to parked position in case toolhead was moved during pause (otherwise the return zhop can error)
        G91                                                                          ; relative positioning
        M83                                                                          ; relative extruder positioning
        {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
            G1 Z{zhop * -1} E{e} F900                                                ; prime nozzle by E, lower Z back down
        {% else %}
            G1 Z{zhop * -1} F900                                                     ; lower Z back down without priming (just in case we are testing the macro with cold hotend)
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60                          ; restore position
        BASE_RESUME                                                                  ; resume print
    {% endif %}




[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout} ; set timeout back to configured value
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    PRINT_END
    BASE_CANCEL_PRINT




[gcode_macro LOAD_FILAMENT]
variable_load_distance:  72
variable_purge_distance:  25
gcode:
    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0
    G1 E{load_distance} F1500 # fast-load
    G1 E{purge_distance} F1000 # purge
    RESTORE_GCODE_STATE NAME=load_state



[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  80
gcode:
    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0
    G1 E-{unload_distance} F1500 # fast-unload
    RESTORE_GCODE_STATE NAME=unload_state


[gcode_macro NO_FILAMENT]
gcode:
    UNLOAD_FILAMENT
    PARK


[gcode_macro Caselight_OFF]
gcode:
    SET_PIN PIN=caselight VALUE=0
    set_nozzle_leds_off

[gcode_macro Caselight_ON]
gcode:
    SET_PIN PIN=caselight VALUE=1
    set_nozzle_leds_on


########################################################
#   Replace M140
########################################################
[gcode_macro M140]
variable_buffer: 20
gcode:
    {% set s = params.S|float %}
    {% set small_bed_temp = printer.small_bed.temperature|float %}
    {% set large_bed_temp = printer.large_bed.temperature|float %}


        {% if (large_bed_temp > small_bed_temp) %}
            SET_HEATER_TEMPERATURE HEATER=large_bed TARGET={ s }
        {% else %}
            SET_HEATER_TEMPERATURE HEATER=small_bed TARGET={ s + 5 }
        {% endif %}


########################################################
#   laser
########################################################

[gcode_macro READY_TO_LASER]
gcode:
    SET_VELOCITY_LIMIT ACCEL=3000
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5
    
    TURN_OFF_HEATERS

    # Homing
    STATUS_HOMING												# Sets SB-leds to homing-mode
    G28 X Y                  									# Homing X Y
    Attach_Probe_lock                                           # Attach klicky probe
    G28 Z                                                       # Homing Z (do not release klicky)
    G90                   										# Absolut position

	# Quad gantry level
	BED_MESH_CLEAR       										# Clears old saved bed mesh (if any)
    _CheckProbe action=query
    _QUAD_GANTRY_LEVEL
    Dock_Probe_unlock
    G1 X200 Y200 Z30 F3000

[gcode_macro LASER_START]
gcode:
    SET_FAN_SPEED FAN=strong_exhaust_fan SPEED=1
    SET_VELOCITY_LIMIT ACCEL=3000
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5
#    SET_FILAMENT_SENSOR SENSOR=filament_runout_sensor ENABLE=0
#    SET_FILAMENT_SENSOR SENSOR=e_stop ENABLE=0


[gcode_macro LASER_END]
gcode:
    SET_FAN_SPEED FAN=strong_exhaust_fan SPEED=0
#    SET_FILAMENT_SENSOR SENSOR=e_stop ENABLE=0

[gcode_macro M3]
gcode:
    {% set S = params.S|default(0.0)|float %}
    SET_PIN PIN=laser VALUE={S / 255.0}

[gcode_macro M4]
gcode:
    {% set S = params.S|default(0.0)|float %}
    SET_PIN PIN=laser VALUE={S / 255.0}

[gcode_macro M5]
gcode:
    SET_PIN PIN=laser VALUE=0


[gcode_macro FOCUS_LASER_EXACT]
gcode:
    G91
    G0 F1000 Z19
    G90

[gcode_macro FOCUS_LASER_CUT]
gcode:
    G91
    G0 F1000 Z18
    G90

[gcode_macro FOCUS_LASER_ENGRAVE]
gcode:
    G91
    G0 F1000 Z21
    G90


########################################################
#   Plotter
########################################################

[gcode_macro READY_TO_PLOT]
gcode:
    TURN_OFF_HEATERS

    # Homing
    STATUS_HOMING												# Sets SB-leds to homing-mode
    G28 X Y                  									# Homing X Y
    Attach_Probe_lock                                           # Attach klicky probe
    G28 Z                                                       # Homing Z (do not release klicky)
    G90                   										# Absolut position

	# Quad gantry level
	BED_MESH_CLEAR       										# Clears old saved bed mesh (if any)
    _CheckProbe action=query
    _QUAD_GANTRY_LEVEL

    # Bed leveling
    status_meshing
    _BED_MESH_CALIBRATE
    Dock_Probe_unlock

    SET_VELOCITY_LIMIT ACCEL=3000
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5
    G1 X200 Y200 Z30 F3000
    status_ready


[save_variables]
filename:variables.cfg


[gcode_macro SAVE_PLOT_OFF_Z]
gcode:
    G91
    G1 Z1
    G90
    {% set z_pos = printer.toolhead.position.z %}
    SAVE_VARIABLE VARIABLE=saved_z VALUE={z_pos}


[gcode_macro PLOT_OFF]
gcode:
    G1 Z{printer.save_variables.variables.saved_z}


[gcode_macro PLOT_ON]
gcode:
    G1 Z{printer.save_variables.variables.saved_z - 3}

    
##########################################################	
#######################  Include  ########################
##########################################################


# Sensorless homing
[include sensorless.cfg]


# Klicky Z-Probe
#[include klicky-probe.cfg]


# Stealtburner Neopixel LEDs
[include stealthburner_leds.cfg]


[include K-ShakeTune/*.cfg]


[include timelapse.cfg]

##########################################################	
#####################  SAVE_CONFIG  ######################
##########################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [small_bed]
#*# control = pid
#*# pid_kp = 33.766
#*# pid_ki = 1.294
#*# pid_kd = 220.325
#*#
#*# [extruder]
#*# pid_kp = 32.014
#*# pid_ki = 14.228
#*# pid_kd = 18.008
#*# control = pid
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.098641, 0.123864, 0.076868, 0.057564, 0.094794, 0.119442, 0.132669, 0.146424, 0.176077
#*# 	  0.036851, 0.076868, 0.045980, 0.032906, 0.099866, 0.127665, 0.146424, 0.181617, 0.224838
#*# 	  -0.027800, 0.015970, -0.003275, 0.008002, 0.062713, 0.125077, 0.117625, 0.136456, 0.190768
#*# 	  -0.076478, -0.009105, -0.042563, -0.026518, 0.022418, 0.065368, 0.092164, 0.081977, 0.136456
#*# 	  -0.065626, -0.033140, -0.037204, -0.035916, -0.011848, 0.034158, 0.040796, 0.021207, 0.099866
#*# 	  -0.087377, -0.045350, -0.064117, -0.073657, -0.043854, -0.009105, 0.001463, -0.003815, 0.065368
#*# 	  -0.018439, -0.021192, -0.050728, -0.029090, -0.018439, 0.004004, 0.015865, 0.017230, 0.109979
#*# 	  0.066610, 0.085804, 0.043297, 0.035593, 0.036851, 0.094794, 0.094794, 0.098641, 0.247628
#*# 	  0.217540, 0.210358, 0.180982, 0.160095, 0.192094, 0.212710, 0.224838, 0.270192, 0.435625
#*# tension = 0.2
#*# min_x = 10.0
#*# algo = bicubic
#*# y_count = 9
#*# mesh_y_pps = 2
#*# min_y = 30.0
#*# x_count = 9
#*# max_y = 380.0
#*# mesh_x_pps = 2
#*# max_x = 394.96
#*#
#*# [large_bed]
#*# control = pid
#*# pid_kp = 58.015
#*# pid_ki = 1.357
#*# pid_kd = 620.040
#*#
#*# [probe]
#*# z_offset = 5.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 45.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 34.6
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = 0.0031953218856001875
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [probe_eddy_ng btt_eddy]
#*# calibrated_drive_currents = 15, 16
#*# calibration_version = 5
#*# reg_drive_current = 16
#*# tap_drive_current = 16
#*# calibration_15 = gASVygMAAAAAAAB9lCiMAXaUSwWMBGZ0b2iUjBtudW1weS5wb2x5bm9taWFsLnBvbHlub21pYWyUjApQb2x5bm9taWFslJOUKYGUfZQojARjb2VmlIwVbnVtcHkuY29yZS5tdWx0aWFycmF5lIwMX3JlY29uc3RydWN0lJOUjAVudW1weZSMB25kYXJyYXmUk5RLAIWUQwFilIeUUpQoSwFLCoWUaAyMBWR0eXBllJOUjAJmOJSJiIeUUpQoSwOMATyUTk5OSv////9K/////0sAdJRiiUNQHbr3cPtp9z/C6/410H7+P1DahcvRe+k/KGN9OWvB3T/ErUQQlHqeP8JQjvkON86/nc+Kf1C20T/4Ip2v+pzgPzIoAV32yqO/95E9v/sLyL+UdJRijAZkb21haW6UaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxCiPioCMOWUPqgmz+5DGJU+lHSUYowGd2luZG93lGgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQAAAAAAAA8L8AAAAAAADwP5R0lGKMB19zeW1ib2yUjAF4lIwGc3ltYm9slGgsdWKMCWZ0b2hfaGlnaJRoBSmBlH2UKGgIaAtoDksAhZRoEIeUUpQoSwFLCoWUaBiJQ1CHO6WJr5EbQFIIHbhLjApAHwTbH05P/T/O3Wbw+NIOQIoSB3ZGqc2/oHrxZlnKJcBUdDVS1ewGQE1KvJaYUTFAKPqwNscB979gJkPpgHkgwJR0lGJoHWgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQ+DqSHnEWlT63hfOTGCSVPpR0lGJoJGgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQAAAAAAAA8L8AAAAAAADwP5R0lGJoK2gsaC1oLHVijARodG9mlGgFKYGUfZQoaAhoC2gOSwCFlGgQh5RSlChLAUsKhZRoGIlDUC8zjHkyCpU+7+42vomCFT72OEH2GhoEvnFmaS5M8Og9OoOpHoMV4b1yoWpyUv7sPS/DJ4dQQdE94A+m2+sg9r3Ho0N8vn22vczXKIrHauY9lHSUYmgdaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxAARTxNv7ivP0olgJAO7hNAlHSUYmgkaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxAAAAAAAADwvwAAAAAAAPA/lHSUYmgraCxoLWgsdWKMB2hfcmFuZ2WUXZQoRz+vuL9NPEUAR0At/WimRmTQZYwHZl9yYW5nZZRdlChHQUg35VuMEABHQUiAzx5M8ABljAJkY5RLD3Uu
#*# calibration_16 = gASVygMAAAAAAAB9lCiMAXaUSwWMBGZ0b2iUjBtudW1weS5wb2x5bm9taWFsLnBvbHlub21pYWyUjApQb2x5bm9taWFslJOUKYGUfZQojARjb2VmlIwVbnVtcHkuY29yZS5tdWx0aWFycmF5lIwMX3JlY29uc3RydWN0lJOUjAVudW1weZSMB25kYXJyYXmUk5RLAIWUQwFilIeUUpQoSwFLCoWUaAyMBWR0eXBllJOUjAJmOJSJiIeUUpQoSwOMATyUTk5OSv////9K/////0sAdJRiiUNQeC2r7zUz9j+UPen/OIL+P2Y56ESVM+k/rQtIIg010T+ceBfcb93JP25FMlf6p+Y/5Ke9FdVRqD8cAlgtU6TrvyBgGpRYKLI/JNPrJ0kh3j+UdJRijAZkb21haW6UaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxBQv7JUtfSUPgYLbldZLpU+lHSUYowGd2luZG93lGgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQAAAAAAAA8L8AAAAAAADwP5R0lGKMB19zeW1ib2yUjAF4lIwGc3ltYm9slGgsdWKMCWZ0b2hfaGlnaJRoBSmBlH2UKGgIaAtoDksAhZRoEIeUUpQoSwFLCoWUaBiJQ1CK0DmSbUYbQG+AP2COwApAwZRrXE+3/D8agIzmQDMAQOQFIM2P7Ng/Zh5FaBbzCcADSbYWAIjsP7IKRV/aTBdASUoE4s+Pib93Xp7UZMYEwJR0lGJoHWgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQwvL+xEkslT4Re7iWAjuVPpR0lGJoJGgLaA5LAIWUaBCHlFKUKEsBSwKFlGgYiUMQAAAAAAAA8L8AAAAAAADwP5R0lGJoK2gsaC1oLHVijARodG9mlGgFKYGUfZQoaAhoC2gOSwCFlGgQh5RSlChLAUsKhZRoGIlDUPZepbjxHpU+nDuvlzHLFz7/oDO8yqIHviyDmQmj/vA9yNl2LPpy371Ycpx1ghDnPSQePf86T9A9TNI8UKWX8L2kF4/dCAPGvQgA4VskjuA9lHSUYmgdaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxBi1j+FO5F5P5o5LUWW8BNAlHSUYmgkaAtoDksAhZRoEIeUUpQoSwFLAoWUaBiJQxAAAAAAAADwvwAAAAAAAPA/lHSUYmgraCxoLWgsdWKMB2hfcmFuZ2WUXZQoRz95kTuFP9ZiR0At/y3iq+hUZYwHZl9yYW5nZZRdlChHQUgdwc4OaABHQUhuqTgsIABljAJkY5RLEHUu
